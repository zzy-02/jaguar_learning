>编写日期：2025年12月14日
作者：周梓芸
# Linux 启动过程可以分为5个阶段
内核的引导 → 运行 init/systemd → 系统初始化 → 建立终端 → 用户登录系统

![示意](https://www.runoob.com/wp-content/uploads/2014/06/bg2013081707.png)

### 1. 内核的引导
当计算机打开电源后，首先是BIOS开机自检，按照BIOS中的设置启动设备（通常是硬盘，也有PXE启动）来启动。

操作系统接管硬件后，首先读入/boot目录下的内核文件。

>PS：
此前为ISCSI boot配置kos510环境就是涉及到修改内核参数并固定的内容。
这里贴出来作为一个示例
```shell
vim /etc/default/grub

# 下面内容同上，找一个合适的位置插入，别的内容别动。...的位置是原本的内容别动！！！！
GRUB_CMDLINE_LINUX="...keyarchos-swap  \
rd.iscsi.initiator=iqn.2025-08.com.client:client01 \
netroot=iscsi:@192.168.70.90::3260::iqn.2025-08.com.example:keyarchos-5.10 \
rd.neednet=1 \
ip=192.168.70.119:::255.255.255.0::p65p1:none \
rd. lom. lv=keyarchos_ keyarchos...\
rhgb quiet"

# 固定命令，因系统而异，链接中的文档对应的命令可能稍有区别，该kos510最好用这个
grub2-mkconfig -o /boot/efi/EFI/kos/grub.cfg
```

### 2. init进程

首先，了解一下init程序的类型
- SysVinit：最早，CentOS 6、早期RHEL
    - 配置文件： /etc/inittab
- Upstart：过渡期，Ubuntu 14.04以前
    - 配置文件： /etc/inittab, /etc/init/*.conf
- **systemd**：现代主流，RHEL7+、CentOS7+、Ubuntu 16.04+，并行强大。
    - 配置文件： /usr/lib/systemd/system、 /etc/systemd/system。
- OpenRC：小众，Alpine、Gentoo

init进程是系统所有进程的起点，首先要读取配置文件

> Tips:如何判断当前系统使用的是哪种init：`ps -p 1 -o comm=` 或者 `ls -l /sbin/init`

### 3. 运行级别

许多程序都是开机启动，在Windows中叫做服务(service)，在Linux中叫做“守护进程”(daemon)。

init进程的一大任务，就是去运行这些开机启动的程序。

但是，不同的场合需要启动不同的程序，比如用作服务器时，需要启动Apache，用作桌面就不需要。

Linux允许为不同的场合，分配不同的开机启动程序，这就叫做"运行级别"（runlevel）。也就是说，启动时根据"运行级别"，确定要运行哪些程序。

>Linxu有7个运行级别：
运行级别0：系统停机状态，系统默认运行级别不能设为0，否则不能正常启动，poweroff.target
运行级别1：单用户工作状态，root权限，用于系统维护，禁止远程登录，rescue.target
运行级别2：多用户状态(没有NFS)
**运行级别3**：最常用的，完全的多用户状态(有NFS)，登录后进入控制台**命令行模式**，multi-user.target
运行级别4：系统未使用，保留
**运行级别5**：另外一个常用模式，X11控制台，登录后进入图形GUI模式，graphical.target
运行级别6：系统正常关闭并重启，默认运行级别不能设为6，否则不能正常启动，reboot.target

> Tips:
查看当前的运行模式：`systemctl get-default`
切换运行级别：`systemctl isolate graphical.target`
设置启动默认：`systemctl set-default multi-user.target`

### 4. systemd初始化
鉴于现在常用的操作系统，这里主要介绍systemd的init进程：

systemd 在系统初始化时，内核执行的是 `/sbin/init`（链接到 systemd），systemd 随后根据 `/etc/systemd/system/default.target`，加载并执行相关的 `unit` 文件（.service、.mount 等），而不是调用 init 中的某一个配置文件。

Rocky8/9、龙蜥8/23、麒麟10等现代服务器 OS 都使用 systemd 作为 init。
内核启动后执行 /sbin/init（链接到 systemd），systemd 通过 ``default.target`` 拉起各类 **unit** 完成系统初始化，而不是依赖某个 init 配置文件。

有时systemd为了兼容旧软件仍会支持`/etc/init.d/xxx`，启动时会生成 `sysv-generator unit`

便于理解，以sshd为例举一个服务是如何在初始化被调用的
```bash
# systemd解析，运行级别3
multi-user.target

# 发现依赖
Requires=sshd.service

# 找到对应的unit文件
/lib/systemd/system/sshd.service

# 执行unit文件中的ExecStart
ExecStart=/usr/sbin/sshd -D
```

此外，虽然说现在os基本都是systemd，但是不排除有些还有曾使用sysv的研发，喜欢兼容一些sysv的文件，最为典型的就是创建`/etc/rc.local`和`/etc/systemd/system/rc-local.service`这两个rc(run commands)启动文件。这一部分参考其他和工作相关这节。下面简单说说rc.local文件执行的条件（可以参考链接：https://space.jaguarmicro.com/pages/viewpage.action?pageId=220923050 中 1.4节）：
- 文件存在  `vim /etc/rc.local`
- 有可执行权限 `chmod +x /etc/rc.d/rc.local`
- rc-local.service 启用：参考如下
```bash
vim /etc/systemd/system/rc-local.service
# 编辑文件内容，一般这部分内容不要我写

# 使能文件
sudo systemctl enable rc-local
sudo systemctl start rc-local
```

### 5. 建立终端&用户登录
>先解释一下什么是终端：用户与操作系统进行交互的输入输出接口。
在Linux中，终端不是一个界面，而是一个字符设备：`/dev/tty*`
该字符设备负责：接收字符输入(键盘/串口/网络)、输出字符(屏幕/串口/ssh)

常见的终端：
- tty1、tty2...：本地屏幕终端
- **pts/0**：ssh终端
- ttyS0：串口
- **ttyACM0**：USB串口
> Tips:
看“我自己”当前登录用的是什么：`tty`
看“所有登录用户”的 tty / pts：`who/w`（有ip的基本都是ssh）
systemd 视角看登录会话（推荐）：`loginctl`
看进程属于哪个tty：`ps -o pid,tty,cmd -p $$`
看历史登录用过哪些 tty / pts：`last`


终端建立：
```bash
# 本地终端登录
终端 → getty(接线员) → agetty(出login) → login+PAM(身份验证)  → user@ → shell(真正对话的人)

# ssh登录
systemd → sshd → PAM → user@ → bash
```
>PAM 会做：校验密码、检查用户是否允许登录、设置 ulimit、挂载 home、创建会话

**systemd 通过 getty@.service建立终端，agetty 提供登录提示，login/sshd 结合 PAM 完成认证，随后 systemd 创建 user@UID.service管理用户会话，最后启动用户的 shell。**

### Linux关机流程

Linux 关机时由 systemd 接管，切换到 poweroff.target，按依赖关系依次终止用户会话和系统服务，卸载文件系统，最终由内核完成断电。

```
poweroff：断电
systemctl poweroff

shutdown 关机指令，你可以man shutdown 来看一下帮助文档。例如你可以运行如下命令关机：

shutdown –h 10 ‘This server will shutdown after 10 mins’ 
这个命令告诉大家，计算机将在10分钟后关机，并且会显示在登陆用户的当前屏幕中。

shutdown –h now 
立马关机

shutdown –h 20:25 
系统会在今天20:25关机

shutdown –h +10 
十分钟后关机

shutdown –r now 
系统立马重启

reboot 
回到BIOS，就是重启，等同于 shutdown –r now

halt 
停止CPU，关闭系统，等同于shutdown –h now 和 poweroff
```
关机会遇到的卡点：如`A stop job is running for xxx.service`
可以使用`systemctl status xxx`排查

### 其他：工作上和这个相关的内容补充，重要！！！

>本部分也算是一个工作小结：2025.10.22-2025.12.14
第一周10.22-10.24：熟悉环境，安装工具
第二周10.27-10.31：RNIC部署、RNIC测试用例手动执行
第三周11.3-11.7：RNIC部署、升级、验证。使用RNIC_Release_2504版本固件 + B100_251105-2主线版本驱动 升级 B100_251105-2主线版本验证2x200G、1x200G、2x100G
第四周11.10-11.14：MicroServer 集成用例流水线编写。rnic2.7装备验证。rnic6.18验证
第五周11.17-11.21：RNIC、DPU两个形态的commit信息插入到邮件中，了解自动化代码
第六周11.24-11.28：iSCSI配置kos510，excel脚本取链接
第七周12.01-12.5：B110版本测试，全量自动化用例执行、内核用例合入
第八周12.8-12.12：SNIC3.2.0装备版本测试

后续要记录的笔记：ip netns\tcpdump\linux命令、modprobe
Linux yum 命令、Linux apt 命令、mtr、iperf 、rpm、dnf
https://www.runoob.com/linux/linux-command-manual.html


